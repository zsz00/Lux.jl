<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Add new functionality to Lux · Lux</title><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.044/juliamono.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.11/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="../../assets/custom.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">Lux</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Lux: Explicitly Parameterized Neural Networks</a></li><li><span class="tocitem">Introduction</span><ul><li><a class="tocitem" href="../../introduction/overview/">All about Lux</a></li><li><a class="tocitem" href="../../introduction/ecosystem/">Ecosystem</a></li></ul></li><li><span class="tocitem">Examples</span><ul><li><input class="collapse-toggle" id="menuitem-3-1" type="checkbox"/><label class="tocitem" for="menuitem-3-1"><span class="docs-label">Beginner</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../examples/generated/beginner/Basics/main/">Julia &amp; Lux for the Uninitiated</a></li><li><a class="tocitem" href="../../examples/generated/beginner/SimpleRNN/main/">Training a Simple LSTM</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-2" type="checkbox"/><label class="tocitem" for="menuitem-3-2"><span class="docs-label">Intermediate</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../examples/generated/intermediate/NeuralODE/main/">MNIST NeuralODE Classification</a></li><li><a class="tocitem" href="../../examples/generated/intermediate/BayesianNN/main/">Bayesian Neural Network</a></li></ul></li><li><span class="tocitem">Advanced</span></li><li><a class="tocitem" href="../../examples/">Additional Examples</a></li></ul></li><li><span class="tocitem">API</span><ul><li><a class="tocitem" href="../../api/layers/">Layers</a></li><li><a class="tocitem" href="../../api/functional/">Functional</a></li><li><a class="tocitem" href="../../api/core/">Core</a></li><li><a class="tocitem" href="../../api/utilities/">Utilities</a></li></ul></li><li><span class="tocitem">Design Docs</span><ul><li><a class="tocitem" href="../documentation/">Documentation</a></li><li><a class="tocitem" href="../recurrent/">Recurrent Neural Networks</a></li><li class="is-active"><a class="tocitem" href>Add new functionality to Lux</a><ul class="internal"><li><a class="tocitem" href="#Mutability"><span>Mutability</span></a></li><li><a class="tocitem" href="#Branching-–-Generated-Functions"><span>Branching – Generated Functions</span></a></li></ul></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Design Docs</a></li><li class="is-active"><a href>Add new functionality to Lux</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Add new functionality to Lux</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/avik-pal/Lux.jl/blob/master/docs/src/design/core.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Adding-New-Functionality/Layers"><a class="docs-heading-anchor" href="#Adding-New-Functionality/Layers">Adding New Functionality/Layers</a><a id="Adding-New-Functionality/Layers-1"></a><a class="docs-heading-anchor-permalink" href="#Adding-New-Functionality/Layers" title="Permalink"></a></h1><p>For Style we try to follow <a href="https://github.com/SciML/SciMLStyle">SciMLStyle</a>. The only reason we don&#39;t have a badge yet, is we haven&#39;t yet updated the package to followed all the guidelines. Here, I am documenting some additional guidelines we enforce:</p><h2 id="Mutability"><a class="docs-heading-anchor" href="#Mutability">Mutability</a><a id="Mutability-1"></a><a class="docs-heading-anchor-permalink" href="#Mutability" title="Permalink"></a></h2><p>See https://github.com/SciML/SciMLStyle#out-of-place-and-immutability-is-preferred-when-sufficient-performant for reference. This is strictly enforced, i.e. all layers/functions provided as part of the external API must be pure functions, even if they come with a performance penalty.</p><h2 id="Branching-–-Generated-Functions"><a class="docs-heading-anchor" href="#Branching-–-Generated-Functions">Branching – Generated Functions</a><a id="Branching-–-Generated-Functions-1"></a><a class="docs-heading-anchor-permalink" href="#Branching-–-Generated-Functions" title="Permalink"></a></h2><p>Zygote doesn&#39;t like branches in code. Like it or not, we are stuck with it for the near future. Even if julia is able to optimize branches away, Zygote will most certainly throw away those optimizations (these can be tested via <code>Zygote.@code_ir</code>).</p><h3 id="Writing-efficient-non-branching-code-to-make-Zygote-happy"><a class="docs-heading-anchor" href="#Writing-efficient-non-branching-code-to-make-Zygote-happy">Writing efficient non-branching code to make Zygote happy</a><a id="Writing-efficient-non-branching-code-to-make-Zygote-happy-1"></a><a class="docs-heading-anchor-permalink" href="#Writing-efficient-non-branching-code-to-make-Zygote-happy" title="Permalink"></a></h3><ul><li>Rely on <code>@generated</code> functions to remove <strong>most</strong> runtime branching. Certain examples:<ul><li>Layers behaving differently during training and inference – we know at compile-time whether a layer is being run in training/inference mode via <code>istraining(st)</code>.</li><li>Composite Layers relying on a variable number of internal layers – Again we know the length of the number of internal layers at compile time. Hence we can manually unroll the loops. See <a href="../../api/layers/#Lux.Parallel"><code>Parallel</code></a>, <a href="../../api/layers/#Lux.Chain"><code>Chain</code></a>, etc.</li></ul></li><li>Pass around <code>Val</code> in state. <code>Flux.jl</code> sets <code>training</code> to be <code>(:auto, true, false)</code>. Hence, which branch will be evaluated, will have to be determined at runtime time (<em>bad</em>). Instead if we pass <code>Val(true)</code>, we will be able to specialize functions directly based on <code>true</code>, <code>false</code>, etc. ensuring there is no runtime cost for these operations. See <a href="../../api/layers/#Lux.BatchNorm"><code>BatchNorm</code></a>, <a href="../../api/layers/#Lux.Dropout"><code>Dropout</code></a>, etc.</li></ul></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../recurrent/">« Recurrent Neural Networks</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.18 on <span class="colophon-date" title="Wednesday 25 May 2022 23:31">Wednesday 25 May 2022</span>. Using Julia version 1.7.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
